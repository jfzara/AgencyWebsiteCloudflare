---
import Layout from '../layouts/Layout.astro';
import Container from '../components/shared/Container.astro';
import Title from '../components/shared/Title.astro';
import { Resend } from 'resend';

// Initialiser Resend
const resend = new Resend(import.meta.env.PUBLIC_RESEND_API_KEY);

// Variables pour les messages
let errorMessage = '';
let successMessage = '';

// Gérer la soumission du formulaire
if (Astro.request.method === 'POST') {
    try {
        const data = await Astro.request.formData();
        const name = data.get('name')?.toString() || '';
        const email = data.get('email')?.toString() || '';
        const company = data.get('company')?.toString() || '';
        const phone = data.get('phone')?.toString() || '';
        const message = data.get('message')?.toString() || '';

        const { data: emailResponse, error } = await resend.emails.send({
            from: 'onboarding@resend.dev',
            to: 'zarajeanfabrice@gmail.com',
            subject: `Nouveau contact de ${name} - ${company}`,
            html: `
                <h2>Nouveau message de contact</h2>
                <p><strong>Nom:</strong> ${name}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>Entreprise:</strong> ${company}</p>
                <p><strong>Téléphone:</strong> ${phone}</p>
                <p><strong>Message:</strong></p>
                <p>${message}</p>
            `
        });

        if (error) {
            console.error('Erreur lors de l\'envoi:', error);
            errorMessage = 'Une erreur est survenue lors de l\'envoi du message.';
        } else {
            successMessage = 'Message envoyé avec succès!';
        }
    } catch (error) {
        console.error('Erreur:', error);
        errorMessage = 'Une erreur est survenue lors de l\'envoi du message.';
    }
}
---

<Layout title="Contact - Prenez rendez-vous">
    <main class="pt-32">
        <Container>
            <div class="max-w-3xl mx-auto">
                <div class="mb-16">
                    <Title>
                        Inquiry Form
                    </Title>
                    
                    {errorMessage && (
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <span class="block sm:inline">{errorMessage}</span>
                        </div>
                    )}

                    {successMessage && (
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <span class="block sm:inline">{successMessage}</span>
                        </div>
                    )}
                    
                    <form class="mt-8" method="post">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <input 
                                    type="text" 
                                    name="name" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-box-bg dark:border-box-border dark:text-heading-2" 
                                    placeholder="*Name" 
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <input 
                                    type="email" 
                                    name="email" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-box-bg dark:border-box-border dark:text-heading-2" 
                                    placeholder="*Email" 
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <input 
                                    type="text" 
                                    name="company" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-box-bg dark:border-box-border dark:text-heading-2" 
                                    placeholder="*Company name" 
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <input 
                                    type="tel" 
                                    name="phone" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-box-bg dark:border-box-border dark:text-heading-2" 
                                    placeholder="Phone Number" 
                                    pattern="[0-9()#&+*-=.]+"
                                />
                            </div>
                            <div class="form-group col-span-2">
                                <label class="block text-sm font-medium text-heading-2 dark:text-heading-2 mb-2">Message</label>
                                <textarea 
                                    name="message" 
                                    rows="4" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-box-bg dark:border-box-border dark:text-heading-2" 
                                    placeholder="Anything we need to know before we start chatting"
                                ></textarea>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button 
                                type="submit" 
                                class="w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark transition-colors duration-200"
                            >
                                Submit
                            </button>
                        </div>
                    </form>

                    <div class="mt-8 text-center">
                        <a href="mailto:livano@livanoagency.com" class="text-primary hover:text-primary-dark">
                            livano@livanoagency.com
                        </a>
                    </div>
                </div>

                <div class="mt-16">
                    <Title>
                        Prenez rendez-vous
                    </Title>
                    
                    <div class="calendly-wrapper">
                        <div 
                            id="calendly-section"
                            class="calendly-inline-widget" 
                            data-url="https://calendly.com/livano-livanoagency/30min" 
                            style="min-width:320px;height:700px;">
                        </div>
                        <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
                    </div>
                </div>
            </div>
        </Container>
    </main>
</Layout>

<style>
    /* Wrapper pour le widget Calendly */
    .calendly-wrapper {
        position: relative;
        width: 100%;
        height: 700px;
        overflow: hidden !important;
    }

    /* Widget Calendly */
    .calendly-inline-widget {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden !important;
        -ms-overflow-style: none !important;
        scrollbar-width: none !important;
    }

    .calendly-inline-widget::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
    }

    /* Styles pour l'iframe générée */
    :global(iframe[src*="calendly"]) {
        overflow: hidden !important;
        -ms-overflow-style: none !important;
        scrollbar-width: none !important;
    }

    :global(iframe[src*="calendly"]::-webkit-scrollbar) {
        display: none !important;
        width: 0 !important;
    }

    /* Masquer toutes les scrollbars */
    :global(.simplebar-scrollbar),
    :global(.simplebar-track) {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
</style>